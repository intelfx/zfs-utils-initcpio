#!/usr/bin/busybox sh
# shellcheck shell=busybox disable=SC3003

# cmdline format:
#
# use a particular dataset:
#    root=zfs:pool/dataset
# use the bootfs property of a pool:
#    root=zfs:pool
# import all pools and use the first one with a bootfs property:
#    root=zfs

set -eo pipefail

SCRIPT_NAME="zfs-root-generator"
LIB_DIR="/usr/lib/zfs/initcpio"
# shellcheck source=zfs-functions
. "$LIB_DIR/zfs-functions"


#
# functions
#

enable_unit() {
	local unit="$1" target="$2"
	log "adding $unit to $target"
	install -dm755 "$GENERATOR_DIR/$target.wants"
	ln -rsf "$GENERATOR_DIR/$unit" -t "$GENERATOR_DIR/$target.wants"
}

write_unit() {
	local unit="$1"
	log "writing $unit"
	{
		cat <<-"EOF"
		# Automatically generated by zfs-root-generator

		EOF
		cat
	} | install -Dm644 /dev/stdin "$GENERATOR_DIR/$unit"
}

write_common_units() {
	write_unit zfs-initrd-prepare.service <<-EOF
	[Unit]
	Description=Prepare to mount ZFS rootfs
	DefaultDependencies=no
	Wants=zfs-initrd-import.target
	After=zfs-initrd-import.target
	Before=initrd-root-device.target

	[Service]
	Type=oneshot
	RemainAfterExit=yes
	EnvironmentFile=-/etc/default/zfs
	ExecStart=${LIB_DIR}/zfs-prepare-rootfs
	PassEnvironment=ZFS_ROOT_MODE
	PassEnvironment=ZFS_ROOT_POOL
	PassEnvironment=ZFS_ROOT_DATASET
	EOF

	enable_unit zfs-initrd-prepare.service initrd-root-device.target
}

write_import_unit() {
	local import_cmds

	case "${ZFS_ROOT_MODE?}" in
		all) import_cmds="\
ExecStart=/usr/bin/zpool import -N -o cachefile=none -a
" ;;

		pool|dataset) import_cmds="\
ExecStart=/usr/bin/zpool import -N -o cachefile=none \${ZFS_ROOT_POOL}
PassEnvironment=ZFS_ROOT_POOL
" ;;

		*) die "invalid \$ZFS_ROOT_MODE=\"$ZFS_ROOT_MODE\"" ;;
	esac

	write_unit zfs-initrd-import-scan.service <<-EOF
	[Unit]
	Description=Import ZFS rootfs pool(s) by device scanning
	Documentation=man:zpool(8)
	DefaultDependencies=no
	Requires=systemd-udev-settle.service
	After=systemd-udev-settle.service
	After=cryptsetup.target
	After=multipathd.service
	Before=zfs-initrd-import.target
	ConditionPathIsDirectory=/sys/module/zfs

	[Service]
	Type=oneshot
	RemainAfterExit=yes
	EnvironmentFile=-/etc/default/zfs
	${import_cmds}
	EOF

	write_unit zfs-initrd-import.target <<-EOF
	[Unit]
	Description=ZFS rootfs pool import target
	Before=initrd-root-device.target
	EOF

	enable_unit zfs-initrd-import-scan.service zfs-initrd-import.target
	enable_unit zfs-initrd-import.target initrd-root-device.target
}

write_mount_unit() {
	# install -Dm644 /dev/stdin "$GENERATOR_DIR/sysroot.mount.d/zfs-override.conf"
	write_unit sysroot.mount <<-EOF
	[Mount]
	PassEnvironment=ZFS_ROOT_DATASET
	Type=zfs
	What=\${ZFS_ROOT_DATASET}
	Where=/sysroot
	Options=zfsutil
	EOF

	# TODO: other mount units from descendant datasets, if the pool has been
	# imported and parsed (i.e. if this is a rerun a la systemd-parse-etc)
}


#
# main
#

setup_debug

GENERATOR_DIR="$1"
if ! [[ "$GENERATOR_DIR" && -d "$GENERATOR_DIR" ]]; then
	die "invalid generator directory \"$GENERATOR_DIR\""
fi

parse_cmdline

case "${ZFS_ROOT_MODE?}" in
all|pool|dataset) ;;
none) log "nothing to do"; exit 0 ;;
*) die "invalid \$ZFS_ROOT_MODE=\"$ZFS_ROOT_MODE\"" ;;
esac

write_common_units
write_import_unit
write_mount_unit

log "done"
exit 0

# vim: ft=sh ts=8 noet:
